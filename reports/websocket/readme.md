# Отчет по домашнему заданию очереди и отложенное выполнение.

### Архитектура и алгоритмы работы вебсокетов

Используются наработки, сделанные в ДЗ по кешированию лены постов, в рамках которого формирования кеша ленты
постов происходило с помощью брокера: при вызове соответствующих ендпоинтов (по созданию поста, добавление подписчиков
и так далее) в брокер для каждого подписчика автора (или самого пользователя, если он подписывается / отписывается на автора) 
отправляется событие о необходимости переформирования ленты постов

В рамках данного ДЗ был добавлен еще один сервис, отвечающий подключение пользователей с помощью websocket, через который
сервис может практический в режими реального времени присылать подписчикам обновление ленты постов.

Алгоритм следующий: когда в сервисе постов создается новый пост, в брокер отправляются несколько сообщения в две очереди, одно
на обновление кеша ленты постов (было реализовано в ДЗ по кешированию), все остальные - на отправку созданного поста подписчикам 
автора. Эти сообщения обрабатывает сервис websocket, который ищет существующие сессии соотвествующих пользователей-подписчиков
и если находит их, отправляет через них новый пост.

### сценарий тестирования
1) В системе должно быть зарегистировано два пользователя (будем обозначать их пользовать А и Б)
2) Необходимо создать подписку пользователя Б на пользователя А
3) Необходимо через ws подключиться _ws://localhost:8084/posts_ (в заголовках обязательно должен присутсвовать заголовок **X-Auth** с jwt токеном пользователя Б)
4) Создать пост от лица пользователя А

Созданный пост должен будет появться в ws пользователя Б

### стек технологий и модулей
- модуль пользователей - хранит информацию о пользователях, отвечает за авторизацию
- модуль постов - хранит посты и информацию по подписках
- модуль диалогов - хранит диалоги между пользователями
- postgres - содержит две реляционные базы для модулей пользователей и постов
- rabbitmq - брокер сообщений, используется для асинхронного запуска формирование кеша ленты постов (для каждого подписчика отдельное событие)
- redis - кеш ленты постов
- citus - используется для шардирования диалогов пользователей
- websocket - сервис для отправки постов пользователям-подписчикам через websocket

для авторизации пользовательских запросов используется jwt, то есть чтобы выполнить запрос необходимо сначала
авторизоваться в модуле пользователей (при успешной авторизации возвращается токен) и далее полученный токен добавлять во все
запросы (в том числе ws) в заголовок **X-Auth**

Запросы можно посмотреть в постман коллекции _postman_collection.json_, также для тестирование полчение сообщений необходимо установить соеднение _ws://localhost:8084/posts_
Для запуска проекта можно использовать _docker-compose.yml_, например командой _docker-compose -p otus-social up --scale worker=2_

