# Отчет по домашнему заданию Распределенные транзакции.

### Архитектура

Добавлен отдельный модуль **counter**, отвечающий за хранение количественных значений определенных сущностей (например,
количество непрочтенных сообщений в диалогах).
Хранение организовано следующим образом:
1) таблица **t_counter** для "поштучного хранения", содержит следующие поля
- entityId, идентификатор сущности
- entityType, тип сущности
- userId, идентификатор пользователя, к которому относится сущность

Например, для сообщений в диалоге данные поля будут содержать следующие значения: 
- entityId = идентификатор сообщения
- entityType = "message" (константа)
- userId = идентификатор пользователя, которому сообщение адресовано

2) таблица **t_counter_sum** для хранения непосредственно количественных показателей. В дальнейшем, для повышения 
пропускной способности, можно перенести хранение количественных показателей в noSql (например redis). Таблица содержит
следующие поля:
- entityType, тип сущности
- userId, идентификатор пользователя, к которому относится сущность
- sum, количественное значение

### Процесс обновления

1) Серсив **counter** через брокер получает сообщение с полями _entityId_, _entityType_, _userId_ и _action_
2) если _action_ = added (то есть добавлено новая сущность), данные сохраняются в таблицу t_counter (при этом, если 
такая сущность в таблице уже присутствует новых записей не добавляется)
3) если _action_ = readed, данные удаляются из таблици t_counter
4) после изменений в таблице t_counter происходит вычисление нового количества для указанного _entityType_, _userId_
которое сохраняется в t_counter_sum
5) по завершению вычислений counter отправляет через брокер сообщение с результатами сохранения 

Такой подход позволяет корректно обрабатывать повторные сообщения из брокера (если придут два одинаковых сообщений на 
добавление сущности в таблице t_counter все равно будет только одна запись)
Уведомление от сервиса counter позволяет сервису, инициировавшему сохранение на своей стороне обрабатывать результаты 
сохранения.

### Возможная дальнейшая модернизация
1) Можно перенести t_counter_sum в noSql
2) Можно рассмотреть шардирование t_counter (например по entityType)
